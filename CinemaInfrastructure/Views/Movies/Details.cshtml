@model CinemaInfrastructure.ViewModels.MovieWithSessionViewModel
@{
    ViewData["Title"] = "Movie Details & Create Session";
}

@if (Model == null || Model.Movie == null)
{
    <div class="alert alert-danger" role="alert">
        Фільм не знайдено.
    </div>
}
else
{
    <main class="container my-5">
        <h1 class="section-title text-center mb-5">@Model.Movie.Title</h1>

        <div class="movie-details-container">
            <!-- Movie Poster with Trailer Play Button -->
            <div class="movie-poster position-relative">
                @if (!string.IsNullOrEmpty(Model.Movie.BannerUrl))
                {
                    <img src="@Model.Movie.BannerUrl" alt="@Model.Movie.Title Poster" class="img-fluid rounded shadow" />
                    @if (!string.IsNullOrEmpty(Model.Movie.TrailerLink))
                    {
                        <button type="button" class="play-slide position-absolute top-50 start-50 translate-middle"
                                data-link="@Model.Movie.TrailerLink"
                                aria-label="Play trailer for @Model.Movie.Title">
                            <img src="~/img/play.png" alt="Play Trailer" class="play-icon" />
                        </button>
                    }
                }
                else
                {
                    <div class="no-poster-placeholder">
                        <p>Постер відсутній</p>
                    </div>
                }
            </div>

            <!-- Movie Details -->
            <div class="movie-info card shadow-sm">
                <div class="card-body">
                    <h2 class="info-title">Інформація про фільм</h2>
                    <div class="info-item">
                        <strong>Опис:</strong>
                        <p>@Model.Movie.Description</p>
                    </div>
                    <div class="info-item">
                        <strong>Мова:</strong>
                        <span>@Model.Movie.Language</span>
                    </div>
                    <div class="info-item">
                        <strong>Тривалість:</strong>
                        <span>@Model.Movie.Duration хв</span>
                    </div>
                    <div class="info-item">
                        <strong>Рік випуску:</strong>
                        <span>@Model.Movie.ReleaseYear</span>
                    </div>
                    <div class="info-item">
                        <strong>Рейтинг:</strong>
                        <span class="rating">⭐ @Model.Movie.Rating</span>
                    </div>
                    <div class="info-item">
                        <strong>Категорії:</strong>
                        <span>
                            @if (Model.Movie.Categories != null && Model.Movie.Categories.Any())
                            {
                                @string.Join(", ", Model.Movie.Categories.Select(c => c.Name))
                            }
                            else
                            {
                                @:Не вказано
                            }
                        </span>
                    </div>
                    <div class="info-item">
                        <strong>Режисери:</strong>
                        <span>
                            @if (Model.Movie.Directors != null && Model.Movie.Directors.Any())
                            {
                                @string.Join(", ", Model.Movie.Directors.Select(d => d.FullName))
                            }
                            else
                            {
                                @:Не вказано
                            }
                        </span>
                    </div>
                    <div class="info-item">
                        <strong>Актори:</strong>
                        <span>
                            @if (Model.Movie.Actors != null && Model.Movie.Actors.Any())
                            {
                                @string.Join(", ", Model.Movie.Actors.Select(a => a.FullName))
                            }
                            else
                            {
                                @:Не вказано
                            }
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trailer Modal -->
        <div class="trailer-modal" id="trailerModal">
            <div class="trailer-modal-content">
                <span class="close-modal">×</span>
                <div class="trailer-container">
                    <iframe id="trailerVideo" frameborder="0" allowfullscreen></iframe>
                </div>
            </div>
        </div>

        <h3 class="booking-heading text-center mb-5">Створити сеанс</h3>

        <form asp-controller="Movies" asp-action="CreateSession" method="post" class="booking-form">
            <input type="hidden" name="MovieId" value="@Model.Movie.Id" />

            <div class="form-section">
                <div class="form-group mb-4">
                    <label for="sessionType" class="form-label">Тип сеансу</label>
                    <select class="form-control" id="sessionType" name="IsPrivate">
                        <option value="false">Публічний (інші можуть приєднатись, 170 грн/квиток)</option>
                        <option value="true">Приватний (весь зал для себе, 1200 грн)</option>
                    </select>
                </div>

                @if (!Model.SelectedCinemaId.HasValue || Model.SelectedCinemaId == 0)
                {
                    <div class="form-group mb-4">
                        <label for="CinemaId" class="form-label">Кінотеатр</label>
                        <select id="CinemaId" name="CinemaId" class="form-control" required>
                            <option value="">-- Оберіть кінотеатр --</option>
                            @if (Model.Cinemas != null)
                            {
                                foreach (var cinema in Model.Cinemas)
                                {
                                    <option value="@cinema.Id">@cinema.Name</option>
                                }
                            }
                        </select>
                    </div>
                }
                else
                {
                    <input type="hidden" name="CinemaId" value="@Model.SelectedCinemaId" />
                    <div class="form-group mb-4">
                        <label class="form-label">Кінотеатр</label>
                        <p class="form-control-plaintext">
                            @(Model.Cinemas.FirstOrDefault(c => c.Id == Model.SelectedCinemaId)?.Name ?? "Невідомо")
                        </p>
                    </div>
                }

                <div class="form-group mb-4">
                    <label for="HallId" class="form-label">Зал</label>
                    <select id="HallId" name="HallId" class="form-control" required>
                        <option value="">-- Оберіть зал --</option>
                        @if (Model.SelectedCinemaId.HasValue && Model.SelectedCinemaId != 0)
                        {
                            var halls = Model.Cinemas.FirstOrDefault(c => c.Id == Model.SelectedCinemaId)?.Halls;
                            if (halls != null)
                            {
                                foreach (var hall in halls)
                                {
                                    <option value="@hall.Id">@hall.Name</option>
                                }
                            }
                        }
                    </select>
                </div>

                <div class="form-group mb-4">
                    <label for="StartDate" class="form-label">Дата показу</label>
                    <input type="date" id="StartDate" name="StartDate" class="form-control" required min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                </div>

                <div class="form-group mb-4">
                    <label for="StartTime" class="form-label">Час початку</label>
                    <select id="StartTime" name="StartTime" class="form-control" required>
                        <option value="">-- Оберіть час --</option>
                    </select>
                </div>
            </div>

            <div class="form-section seat-selection-section" id="seatSelectionGroup" style="display: none;">
                <h4 class="section-title text-center mb-4">Оберіть місця</h4>
                <div id="seatMap" class="hall-structure">
                    <span class="screen"><img src="https://www.palladium-cinema.com.ua/desktop/img/screen.png" alt="Екран" class="img-fluid" /></span>
                    <div class="seats-container">
                        <!-- Seats will be populated dynamically via JavaScript -->
                    </div>
                </div>
                <input type="hidden" id="selectedSeats" name="SelectedSeatIds" />
                <small class="form-text text-muted">Виберіть місця, які хочете забронювати.</small>
                <div class="selected-seats-info mt-4">
                    <p class="seats-label mb-2">Обрані місця:</p>
                    <div id="selectedSeatsList" class="seats-list"></div>
                </div>
            </div>

            <div class="form-section total-price-section">
                <h4 class="section-title text-center mb-3">Загальна вартість</h4>
                <p id="totalPrice" class="total-price text-center">Будь ласка, оберіть тип сеансу та зал</p>
            </div>

            <div class="text-center mt-5">
                <button type="submit" class="btn btn-maroon">Створити сеанс</button>
            </div>
        </form>
    </main>
}

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            let seatCount = 0; // Total seats in the hall
            let selectedSeats = []; // Array to store selected seat IDs

            // Function to update the total price and selected seats display
            function updateTotalPrice() {
                var isPrivate = $('#sessionType').val() === 'true';
                var hallId = $('#HallId').val();
                var startTime = $('#StartTime').val();
                var selectedSeatsList = $('#selectedSeatsList');

                // Update selected seats display
                selectedSeatsList.empty();
                if (selectedSeats.length === 0) {
                    selectedSeatsList.append('<span class="text-muted">Немає обраних місць</span>');
                } else {
                    selectedSeats.forEach(seatId => {
                        var seat = $('.seat[data-id="' + seatId + '"]');
                        var row = seat.attr('title').split(', ')[0].replace('Ряд ', '');
                        var number = seat.text();
                        selectedSeatsList.append(`<div>${row} ряд, ${number} місце</div>`);
                    });
                }

                if (!hallId || !startTime) {
                    $('#totalPrice').text('Будь ласка, оберіть зал і час');
                    return;
                }

                if (isPrivate) {
                    $('#totalPrice').text(`1200 грн (приватний сеанс, весь зал)`);
                    $('#seatSelectionGroup').hide();
                } else {
                    var numberOfSeats = selectedSeats.length;
                    var total = numberOfSeats * 170;
                    $('#totalPrice').text(numberOfSeats > 0 ? `${total} грн (${numberOfSeats} місць x 170 грн/квиток)` : 'Будь ласка, оберіть місця');
                    $('#seatSelectionGroup').show();
                }
            }

            // Show/hide seat selection based on session type
            $('#sessionType').change(function () {
                var isPrivate = $(this).val() === 'true';
                if (isPrivate) {
                    $('#seatSelectionGroup').hide();
                    selectedSeats = [];
                    $('#selectedSeats').val('');
                } else {
                    $('#seatSelectionGroup').show();
                    loadSeats(); // Reload seats when switching to public
                }
                updateTotalPrice();
            });

            // Populate halls if a cinema is pre-selected
            var preSelectedCinemaId = @Html.Raw(Json.Serialize(Model.SelectedCinemaId));
            if (!preSelectedCinemaId || preSelectedCinemaId === 0) {
                $('#CinemaId').change(function () {
                    var cinemaId = $(this).val();
                    $('#HallId').empty().append('<option value="">-- Завантаження... --</option>');
                    $.get('/Movies/GetHalls', { cinemaId: cinemaId }, function (data) {
                        $('#HallId').empty().append('<option value="">-- Оберіть зал --</option>');
                        data.forEach(h => {
                            $('#HallId').append(`<option value="${h.id}">${h.name}</option>`);
                        });
                    });
                });
            }

            // Reset seat selection when hall changes
            $('#HallId').change(function () {
                var hallId = $(this).val();
                if (hallId) {
                    $.get('/Movies/GetHallSeatCount', { hallId: hallId }, function (data) {
                        seatCount = data.seatCount;
                    });
                } else {
                    seatCount = 0;
                }
                selectedSeats = [];
                $('#selectedSeats').val('');
                $('.seats-container').empty();
                updateTotalPrice();
                loadAvailableTimes();
            });

            // Load available times when date and hall are selected
            function loadAvailableTimes() {
                var hallId = $('#HallId').val();
                var selectedDate = $('#StartDate').val();

                if (hallId && selectedDate) {
                    $('#StartTime').empty().append('<option value="">-- Завантаження... --</option>');
                    $.get('/Movies/GetAvailableTimes', { hallId: hallId, selectedDate: selectedDate }, function (data) {
                        $('#StartTime').empty().append('<option value="">-- Оберіть час --</option>');
                        data.forEach(time => {
                            $('#StartTime').append(`<option value="${time}">${time}</option>`);
                        });
                    });
                } else {
                    $('#StartTime').empty().append('<option value="">-- Оберіть зал і дату --</option>');
                }
            }

            $('#StartDate').change(function () {
                loadAvailableTimes();
                selectedSeats = [];
                $('#selectedSeats').val('');
                $('.seats-container').empty();
                updateTotalPrice();
            });

            // Load seats when a time is selected
            function loadSeats() {
                var hallId = $('#HallId').val();
                var startTime = $('#StartTime').val();
                var selectedDate = $('#StartDate').val();
                var isPrivate = $('#sessionType').val() === 'true';

                if (hallId && startTime && selectedDate && !isPrivate) {
                    $.get('/Movies/GetSeatsForHall', { hallId: hallId, selectedDate: selectedDate, startTime: startTime }, function (data) {
                        $('.seats-container').empty();
                        let currentRow = null;
                        let rowDiv = null;

                        data.forEach(seat => {
                            if (currentRow !== seat.row) {
                                currentRow = seat.row;
                                rowDiv = $('<div class="row"></div>').appendTo('.seats-container');
                                $('<span class="number-of-row"></span>').text(currentRow).appendTo(rowDiv);
                                $('<div class="seats"></div>').appendTo(rowDiv);
                            }

                            const seatDiv = $('<div class="seat"></div>')
                                .attr('data-id', seat.id)
                                .text(seat.number)
                                .addClass(seat.isAvailable ? '' : 'booked')
                                .attr('title', `Ряд ${seat.row}, Місце ${seat.number}`)
                                .appendTo(rowDiv.find('.seats'));

                            if (!seat.isAvailable) {
                                seatDiv.addClass('booked');
                            }
                        });

                        // Add click event for seat selection
                        $('.seat').not('.booked').click(function () {
                            const seatId = $(this).data('id');
                            if ($(this).hasClass('selected')) {
                                $(this).removeClass('selected');
                                selectedSeats = selectedSeats.filter(id => id !== seatId);
                            } else {
                                $(this).addClass('selected');
                                selectedSeats.push(seatId);
                            }
                            $('#selectedSeats').val(selectedSeats.join(','));
                            updateTotalPrice();
                        });
                    });
                } else {
                    $('.seats-container').empty();
                    selectedSeats = [];
                    $('#selectedSeats').val('');
                }
            }

            $('#StartTime').change(function () {
                loadSeats();
                updateTotalPrice();
            });

            // Trailer modal logic
            $('.play-slide').click(function () {
                var link = $(this).data('link');
                var videoId = link.includes('v=') ? link.split('v=')[1] : '';
                var ampersandPosition = videoId.indexOf('&');
                if (ampersandPosition !== -1) {
                    videoId = videoId.substring(0, ampersandPosition);
                }
                $('#trailerVideo').attr('src', `https://www.youtube.com/embed/${videoId}?autoplay=1`);
                $('#trailerModal').fadeIn();
            });

            $('.close-modal').click(function () {
                $('#trailerModal').fadeOut();
                $('#trailerVideo').attr('src', '');
            });

            $(window).click(function (e) {
                if ($(e.target).is('#trailerModal')) {
                    $('#trailerModal').fadeOut();
                    $('#trailerVideo').attr('src', '');
                }
            });
        });
    </script>
}

